
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Linkmap Treemap</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      background-color: #1e1e1e;
      color: #fff;
      margin: 0;
      font-family: sans-serif;
    }
    #controls {
      padding: 10px;
      background: #2c2c2c;
      border-bottom: 1px solid #444;
    }
    #chart {
      width: 100vw;
      height: calc(100vh - 40px);
      overflow: hidden;
    }
    .node {
      position: absolute;
      overflow: hidden;
      box-sizing: border-box;
      border: 1px solid #444;
      font-size: 12px;
      color: #000;
      padding: 2px;
    }
  </style>
</head>
<body>
<div id="controls">
  <label for="depth">Глубина: </label>
  <select id="depth">
    <option value="all">All</option>
    <option>1</option>
    <option>2</option>
    <option>3</option>
    <option>4</option>
    <option>5</option>
    <option>6</option>
    <option>7</option>
  </select>
</div>
<div id="chart"></div>
<script>
  const chart = d3.select("#chart");
  const color = d3.scaleOrdinal(d3.schemeCategory10);
  const depthSelect = document.getElementById("depth");

  function draw(data, maxDepth = Infinity) {
    chart.selectAll("*").remove();

    const width = window.innerWidth;
    const height = document.getElementById("chart").clientHeight;

    const root = d3.hierarchy(data).sum(d => d.value || 0).sort((a, b) => b.value - a.value);
    d3.treemap().size([width, height]).paddingInner(2)(root);

    const nodes = chart.selectAll(".node")
      .data(root.descendants().filter(d => d.depth <= maxDepth))
      .join("div")
      .attr("class", "node")
      .style("left", d => d.x0 + "px")
      .style("top", d => d.y0 + "px")
      .style("width", d => Math.max(0, d.x1 - d.x0) + "px")
      .style("height", d => Math.max(0, d.y1 - d.y0) + "px")
      .style("background", d => color(d.depth))
      .text(d => {
        const w = d.x1 - d.x0;
        const h = d.y1 - d.y0;
        return (w > 40 && h > 20) ? d.data.name : "";
      })
      .append("title")
      .text(d => d.data.name + "\nСсылок: " + (d.data.value || 0));
  }

  fetch("links.json")
    .then(res => res.json())
    .then(data => {
      draw(data);
      depthSelect.addEventListener("change", () => {
        const val = depthSelect.value;
        draw(data, val === "all" ? Infinity : +val);
      });
    })
    .catch(err => {
      chart.append("div").text("Ошибка загрузки links.json");
      console.error(err);
    });
</script>
</body>
</html>
