
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Linkmap Treemap</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      background-color: #1e1e1e;
      color: #fff;
      margin: 0;
      font-family: sans-serif;
    }
    #controls {
      position: relative;
      z-index: 1000;
      padding: 10px;
      background: #2c2c2c;
      border-bottom: 1px solid #444;
    }
    #breadcrumbs {
      display: inline-block;
      color: #fff;
      margin-left: 20px;
      font-size: 14px;
    }
    #breadcrumbs span {
      cursor: pointer;
      color: #4eaaff;
    }
    #breadcrumbs span:hover {
      text-decoration: underline;
    }
    #chart {
      position: relative;
      z-index: 1;
      width: 100vw;
      height: calc(100vh - 40px);
      overflow: hidden;
    }
    .node {
      position: absolute;
      overflow: hidden;
      box-sizing: border-box;
      border: 1px solid #444;
      font-size: 12px;
      color: #000;
      padding: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    select {
      margin-right: 10px;
    }
  </style>
</head>
<body>
<div id="controls">
  <label for="depth">Глубина: </label>
  <select id="depth">
    <option value="1" selected>1</option>
    <option>2</option>
    <option>3</option>
    <option>4</option>
    <option>5</option>
    <option>6</option>
    <option>7</option>
    <option value="all">All</option>
  </select>
  <label for="metric">Размер по: </label>
  <select id="metric">
    <option value="total" selected>total</option>
    <option value="value">value</option>
  </select>
  <button id="reset">Назад</button>
  <div id="breadcrumbs"></div>
</div>
<div id="chart"></div>
<script>
  const chart = d3.select("#chart");
  const depthSelect = document.getElementById("depth");
  const metricSelect = document.getElementById("metric");
  const resetButton = document.getElementById("reset");
  const breadcrumbs = document.getElementById("breadcrumbs");

  const color = d3.scaleOrdinal(d3.schemeCategory10);
  let originalRoot = null;
  let currentFocus = null;
  let pathStack = [];
  const hiddenNodes = new Set();

  function updateBreadcrumbs() {
    breadcrumbs.innerHTML = "";
    pathStack.forEach((node, index) => {
      const crumb = document.createElement("span");
      crumb.textContent = node.data.name || "Корень";
      crumb.onclick = () => {
        currentFocus = node.data;
        pathStack = pathStack.slice(0, index + 1);
        draw(currentFocus, 1);
        depthSelect.value = "1";
      };
      breadcrumbs.appendChild(crumb);
      if (index < pathStack.length - 1) {
        breadcrumbs.append(" > ");
      }
    });
  }

  function getVisibleChildren(data) {
    return (data.children || []).filter(child => !hiddenNodes.has(child.name));
  }

  function draw(focusNode, maxDepth = 1) {
    chart.selectAll("*").remove();

    const width = chart.node().clientWidth;
    const height = chart.node().clientHeight;
    const metric = metricSelect.value;

    const cleanData = JSON.parse(JSON.stringify(focusNode));
    cleanData.children = getVisibleChildren(cleanData);

    const root = d3.hierarchy(cleanData)
      .sum(d => metric === "total" ? (d.total || 0) : (d.value || 0))
      .sort((a, b) => b.value - a.value);

    d3.treemap().size([width, height]).paddingInner(2)(root);

    chart.selectAll(".node")
      .data(root.descendants().filter(d => d.depth <= maxDepth))
      .join("div")
      .attr("class", "node")
      .style("left", d => d.x0 + "px")
      .style("top", d => d.y0 + "px")
      .style("width", d => Math.max(0, d.x1 - d.x0) + "px")
      .style("height", d => Math.max(0, d.y1 - d.y0) + "px")
      .style("background", d => color(d.parent ? d.parent.data.name + "-" + d.data.name : d.data.name))
      .text(d => {
        const w = d.x1 - d.x0;
        const h = d.y1 - d.y0;
        return (w > 40 && h > 20) ? d.data.name : "";
      })
      .on("click", (event, d) => {
        if (event.altKey) {
          hiddenNodes.add(d.data.name);
          draw(currentFocus, 1);
        } else if (event.ctrlKey) {
          hiddenNodes.add(d.data.name);
          d3.select(event.currentTarget).remove();
        } else if (d.children) {
          currentFocus = d.data;
          pathStack.push(d);
          draw(currentFocus, 1);
          depthSelect.value = "1";
          updateBreadcrumbs();
        }
      })
      .append("title")
      .text(d => d.data.name + "\nСсылок: " + (d.data.value || 0));
  }

  fetch("links.json")
    .then(res => res.json())
    .then(data => {
      originalRoot = data;
      const rootNode = d3.hierarchy(data);
      pathStack = [rootNode];
      currentFocus = data;
      draw(currentFocus, 1);
      updateBreadcrumbs();
      depthSelect.value = "1";

      depthSelect.addEventListener("change", () => {
        const val = depthSelect.value;
        draw(currentFocus, val === "all" ? Infinity : +val);
      });

      metricSelect.addEventListener("change", () => {
        draw(currentFocus, depthSelect.value === "all" ? Infinity : +depthSelect.value);
      });

      resetButton.addEventListener("click", () => {
        currentFocus = originalRoot;
        pathStack = [d3.hierarchy(originalRoot)];
        hiddenNodes.clear();
        draw(originalRoot, 1);
        depthSelect.value = "1";
        updateBreadcrumbs();
      });
    })
    .catch(err => {
      chart.append("div").text("Ошибка загрузки links.json");
      console.error(err);
    });
</script>
</body>
</html>
