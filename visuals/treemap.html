<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Linkmap Treemap</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      background-color: #1e1e1e;
      color: #fff;
      margin: 0;
      font-family: sans-serif;
    }
    #controls {
      position: relative;
      z-index: 1000;
      padding: 10px;
      background: #2c2c2c;
      border-bottom: 1px solid #444;
    }
    #breadcrumbs {
      display: inline-block;
      color: #fff;
      margin-left: 20px;
      font-size: 14px;
    }
    #breadcrumbs span {
      cursor: pointer;
      color: #4eaaff;
    }
    #breadcrumbs span:hover {
      text-decoration: underline;
    }
    #chart {
      position: relative;
      z-index: 1;
      width: 100vw;
      height: calc(100vh - 40px);
      overflow: hidden;
    }
    .node {
      position: absolute;
      overflow: hidden;
      box-sizing: border-box;
      border: 1px solid #444;
      font-size: 24px;
      color: #000;
      padding: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    select { margin-right: 10px; }
  </style>
</head>
<body>
  <div id="controls">
    <label for="depth">Глубина: </label>
    <select id="depth">
      <option value="1" selected>1</option>
      <option>2</option><option>3</option><option>4</option>
      <option>5</option><option>6</option><option>7</option>
      <option value="all">All</option>
    </select>
    <label for="metric">Размер по: </label>
    <select id="metric">
      <option value="total-number-of-children" selected>total-number-of-children</option>
      <option value="number-of-children">number-of-children</option>
    </select>
    <button id="reset">Назад</button>
    <div id="breadcrumbs"></div>
  </div>
  <div id="chart"></div>
  <script>
    const chart = d3.select("#chart");
    const depthSelect = document.getElementById("depth");
    const metricSelect = document.getElementById("metric");
    const resetButton = document.getElementById("reset");
    const breadcrumbs = document.getElementById("breadcrumbs");

    const color = d3.scaleOrdinal(d3.schemeCategory10);
    let originalRoot = null, currentFocus = null;
    let pathStack = [];
    const hiddenNodes = new Set();

    function updateBreadcrumbs() {
      breadcrumbs.innerHTML = '';
      pathStack.forEach((node, i) => {
        const span = document.createElement('span');
        span.textContent = node.data.name || 'Корень';
        span.onclick = () => {
          currentFocus = node.data;
          pathStack = pathStack.slice(0, i + 1);
          draw(currentFocus, 1);
          depthSelect.value = '1';
        };
        breadcrumbs.appendChild(span);
        if (i < pathStack.length - 1) breadcrumbs.append(' > ');
      });
    }

    function getVisibleChildren(data) {
      return (data.children || []).filter(c => !hiddenNodes.has(c.name));
    }

    function draw(focusNode, maxDepth = 1) {
      chart.selectAll('*').remove();
      const w = chart.node().clientWidth;
      const h = chart.node().clientHeight;
      const metric = metricSelect.value;

      const dataClone = JSON.parse(JSON.stringify(focusNode));
      dataClone.children = getVisibleChildren(dataClone);

      try {
        const root = d3.hierarchy(dataClone)
          .eachBefore(d => {
            d.value = (metric === 'total-number-of-children')
              ? (d.data['total-number-of-children'] || 0)
              : (d.data['number-of-children'] || 0);
          })
          .sort((a, b) => b.value - a.value);

        d3.treemap().size([w, h]).paddingInner(2)(root);

        chart.selectAll('.node')
          .data(root.descendants().filter(d => d.depth <= maxDepth))
          .join('div')
          .attr('class', 'node')
          .style('left', d => d.x0 + 'px')
          .style('top', d => d.y0 + 'px')
          .style('width', d => Math.max(0, d.x1 - d.x0) + 'px')
          .style('height', d => Math.max(0, d.y1 - d.y0) + 'px')
          .style('background', d =>
            color(d.parent ? `${d.parent.data.name}-${d.data.name}` : d.data.name)
          )
          .text(d => {
            const width = d.x1 - d.x0,
                  height = d.y1 - d.y0;
            return (width > 60 && height > 20)
              ? `${d.data.name} :: ${d.value}`
              : '';
          })
          .on('click', (e, d) => {
            if (e.altKey) {
              hiddenNodes.add(d.data.name);
              if (metric === 'total-number-of-children' && d.parent) {
                d.parent.value -= d.value;
                d.parent.data['total-number-of-children'] =
                  (d.parent.data['total-number-of-children'] || d.parent.value + d.value) - d.value;
              }
              draw(currentFocus, 1);
            } else if (e.ctrlKey) {
              hiddenNodes.add(d.data.name);
              d3.select(e.currentTarget).remove();
            } else if (d.children && d.children.length && d.data.name !== currentFocus.name) {
              currentFocus = d.data;
              pathStack.push(d);
              draw(currentFocus, 1);
              depthSelect.value = '1';
              updateBreadcrumbs();
            }
          })
          .append('title')
          .text(d => `${d.data.name}\nСсылок: ${d.data['number-of-children'] || 0}`);
      } catch (err) {
        chart.append('div')
          .style('color', 'red')
          .text('Ошибка визуализации: ' + err.message);
      }
    }

    fetch('links.json')
      .then(r => r.json())
      .then(data => {
        originalRoot = data;
        const rootNode = d3.hierarchy(data);
        pathStack = [rootNode];
        currentFocus = data;
        draw(currentFocus, 1);
        updateBreadcrumbs();
        depthSelect.value = '1';

        depthSelect.onchange = () => {
          const val = depthSelect.value;
          draw(currentFocus, val === 'all' ? Infinity : +val);
        };
        metricSelect.onchange = depthSelect.onchange;
        resetButton.onclick = () => {
          currentFocus = originalRoot;
          pathStack = [d3.hierarchy(originalRoot)];
          hiddenNodes.clear();
          draw(originalRoot, 1);
          depthSelect.value = '1';
          updateBreadcrumbs();
        };
      });
  </script>
</body>
</html>
